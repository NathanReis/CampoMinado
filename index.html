<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Campo Minado</title>

  <style>
    :root {
      font-size: 24px;
    }

    #abrir-emulador-console {
      text-decoration: underline;
      cursor: pointer;
    }

    #fechar-emulador-console {
      cursor: pointer;
    }

    #campo {
      font-size: 16px;
    }
  </style>
</head>
<body>
  <main>
    <h1>Campo Minado</h1>

    <p>Este jogo foi desenvolvido em Javascript e √© poss√≠vel jogar apenas ferramenta de desenvolvimento do navegador.</p>

    <p>Aperte <code>F12</code> ou <code>Ctrl + Shift + I</code> para abri-l√°. Caso os atalhos n√£o funcionem, verifique qual o correto para sua m√°quina e navegador.</p>

    <p>Com a ferramenta de desenvolimento aberta, v√° na aba "Console".</p>

    <p>Caso esteja em um dispositivo m√≥vel ou n√£o queira jogar pelo conselo, <span id="abrir-emulador-console">click aqui</span> para jogar pela interface.</p>

    <h2>Comandos</h2>

    <ul>
      <li>
        <strong>Abir uma posi√ß√£o no campo:</strong> <br />
        <code>abrirPosicao(x, y)</code> <br />
        <code>x</code>: A linha que deseja abrir. <br />
        <code>y</code>: A coluna que deseja abrir.
      </li>
      <li>
        <strong>Marcar uma poss√≠vel bomba:</strong> <br />
        <code>marcarComBandeira(x, y)</code> <br />
        <code>x</code>: A linha que deseja marcar. <br />
        <code>y</code>: A coluna que deseja marcar.
      </li>
      <li>
      <strong>Reiniciar:</strong> <br />
        <code>reiniciar()</code>
      </li>
    </ul>
  </main>

  <dialog id="emulador-console">
    <span id="fechar-emulador-console">‚ùå</span>

    <pre id="campo"></pre>

    <p id="emulador-log"></p>

    <form>
      <div>
        <label for="posicao-x">X</label>
        <input
          id="posicao-x"
          type="number"
          step="1"
          min="1"
          max="10"
        />
      </div>

      <div>
        <label for="posicao-y">Y</label>
        <input
          id="posicao-y"
          type="number"
          step="1"
          min="1"
          max="10"
        />
      </div>

      <div>
        <button id="abrir-posicao" type="button">Abrir Posi√ß√£o</button>
        <button id="marcar-bomba" type="button">Marcar Bomba</button>
      </div>
    </form>

    <button id="reiniciar" type="button">Reiniciar</button>
  </dialog>

  <script>
    const SETTINGS = Object.freeze({
      campo: Object.freeze({
        tamanhoX: 10,
        tamanhoY: 10,
        simbolos: Object.freeze({
          fechado: '‚¨ú',
          aberto: '‚¨õ',
          0: '0Ô∏è‚É£',
          1: '1Ô∏è‚É£',
          2: '2Ô∏è‚É£',
          3: '3Ô∏è‚É£',
          4: '4Ô∏è‚É£',
          5: '5Ô∏è‚É£',
          6: '6Ô∏è‚É£',
          7: '7Ô∏è‚É£',
          8: '8Ô∏è‚É£',
          9: '9Ô∏è‚É£',
          10: 'üîü',
        }),
      }),
      bombas: Object.freeze({
        quantidade: 10,
        simbolo: 'üí£'
      }),
      bandeiras: Object.freeze({
        simbolo: 'üö©'
      }),
    });

    let campo = [];
    let posicoesBombas = [];
    let posicoesBandeiras = [];
    let posicoesAbertas = [];
    let ehJogoFinalizado = false;
    let ehVitoria = null;

    // Recebe as coordenadas com base na indica√ß√£o do campo, ou seja, os valores
    // v√£o de 1 √† 10, e n√£o de 0 √† 9.
    function abrirPosicao(usuarioX, usuarioY) {
      if (ehJogoFinalizado) {
        return verificarVitoria();
      };

      let posicao = [(usuarioX - 1), (usuarioY - 1)];

      if (!ehPosicaoNoCampo(posicao)) {
        return exibirLog('Posi√ß√µes escolhidas n√£o est√£o no campo!');
      }

      if (ehPosicaoAberta(posicao)) {
        return exibirLog('Posi√ß√£o j√° aberta, escolhe uma diferente!');
      }

      if (ehPosicaoDeBomba(posicao)) {
        ehJogoFinalizado = true;
        ehVitoria = false;
        posicoesAbertas.push(posicao);

        exibirCampo();

        return exibirLog('Voc√™ perdeu! üí•');
      }

      posicoesAbertas.push(posicao);

      removerPosicaoDeBandeira(posicao);

      if (!ehPosicaoDica(posicao)) {
        propagarAbertura(posicao);
      }

      exibirCampo();
      verificarVitoria();
    }

    function propagarAbertura(posicaoAberta) {
      let posicoesEmTorno = [
        [-1, -1], [-1,  0], [-1, +1], // 1 1 1
        [ 0, -1],           [ 0, +1], // 1 B 1
        [+1, -1], [+1,  0], [+1, +1], // 1 1 1
      ];
      let [abertaX, abertaY] = posicaoAberta;

      for (let [emTornoX, emTornoY] of posicoesEmTorno) {
        let posicao = [(abertaX + emTornoX), (abertaY + emTornoY)];

        if (
          ehPosicaoNoCampo(posicao)
          && !ehPosicaoAberta(posicao)
          && !ehPosicaoDeBomba(posicao)
        ) {
          posicoesAbertas.push(posicao);

          removerPosicaoDeBandeira(posicao);

          if (!ehPosicaoDica(posicao)) {
            propagarAbertura(posicao);
          }
        }
      }
    }

    function removerPosicaoDeBandeira(posicao) {
      if (ehPosicaoDeBandeira(posicao)) {
        posicoesBandeiras = posicoesBandeiras.filter((posicaoBandeira) => {
          return !saoArraysIguais(posicao, posicaoBandeira);
        });
      }
    }

    // Recebe as coordenadas com base na indica√ß√£o do campo, ou seja, os valores
    // v√£o de 1 √† 10, e n√£o de 0 √† 9.
    function marcarComBandeira(usuarioX, usuarioY) {
      if (ehJogoFinalizado) {
        return verificarVitoria();
      };

      let posicao = [(usuarioX - 1), (usuarioY - 1)];

      if (!ehPosicaoNoCampo(posicao)) {
        return exibirLog('Posi√ß√µes escolhidas n√£o est√£o no campo!');
      }

      if (ehPosicaoAberta(posicao)) {
        return exibirLog('Posi√ß√£o j√° aberta, escolhe uma diferente!');
      }

      if (ehPosicaoDeBandeira(posicao)) {
        return exibirLog('Posi√ß√£o j√° marcada, escolhe uma diferente!');
      }

      posicoesBandeiras.push(posicao);

      exibirCampo();
      verificarVitoria();
    }

    function verificarVitoria() {
      if (ehJogoFinalizado) {
        return exibirLog(`Voc√™ ${ehVitoria ? 'venceu! üòÑ' : 'perdeu! üí•'}`)
      }

      let totalDePosicoes = SETTINGS.campo.tamanhoX * SETTINGS.campo.tamanhoY;
      let totalDePosicoesDescobertasParaVitoria = totalDePosicoes - SETTINGS.bombas.quantidade;

      let faltaApenasBombas = posicoesAbertas.length === totalDePosicoesDescobertasParaVitoria;

      if (faltaApenasBombas) {
        ehJogoFinalizado = true;
        ehVitoria = true;

        exibirLog('Voc√™ venceu! üòÑ');
      }
    }

    function exibirLog(mensagem) {
      console.log(mensagem);
      document.querySelector('#emulador-log').innerHTML = mensagem;
    }

    function reiniciar() {
      campo = [];
      posicoesBombas = [];
      posicoesBandeiras = [];
      posicoesAbertas = [];
      ehJogoFinalizado = false;
      ehVitoria = null;

      inicializar();
    }

    function inicializar() {
      inicializarCampo();
      sortearPosicoesDasBombas();
      colocarBombasNoCampo();
      colocarDicasNoCampo();
      exibirCampo();
    }

    function inicializarCampo() {
      for (let x = 0; x < SETTINGS.campo.tamanhoX; x++) {
        campo[x] = [];

        for (let y = 0; y < SETTINGS.campo.tamanhoY; y++) {
          campo[x][y] = 0;
        }
      }
    }

    function sortearPosicoesDasBombas() {
      for (let i = 0; i < SETTINGS.bombas.quantidade;) {
        let possivelPosicao = sortearPosicaoNoCampo();

        if (!ehPosicaoDeBomba(possivelPosicao)) {
          posicoesBombas[i] = possivelPosicao;
          i++;
        }
      }
    }

    function colocarBombasNoCampo() {
      for (let [x, y] of posicoesBombas) {
        campo[x][y] = SETTINGS.bombas.simbolo;
      }
    }

    function colocarDicasNoCampo() {
      let posicoesDicas = [
        [-1, -1], [-1,  0], [-1, +1], // 1 1 1
        [ 0, -1],           [ 0, +1], // 1 B 1
        [+1, -1], [+1,  0], [+1, +1], // 1 1 1
      ];

      for (let [bombaX, bombaY] of posicoesBombas) {
        for (let [dicaX, dicaY] of posicoesDicas) {
          let x = bombaX + dicaX;
          let y = bombaY + dicaY;

          if (ehPosicaoNoCampo([x, y]) && !ehPosicaoDeBomba([x, y])) {
            campo[x][y]++;
          }
        }
      }
    }

    function exibirCampo() {
      let desenhoCampo = '';

      for (let y = 0; y <= SETTINGS.campo.tamanhoY; y++) {
        desenhoCampo += `${SETTINGS.campo.simbolos[y]}|`;
      }

      desenhoCampo += '\n\r';

      for (let x = 0; x < SETTINGS.campo.tamanhoX; x++) {
        desenhoCampo += `${SETTINGS.campo.simbolos[(x + 1)]}|`;

        for (let y = 0; y < SETTINGS.campo.tamanhoY; y++) {
          let posicao = [x, y];

          if (ehPosicaoAberta(posicao)) {
            if (ehPosicaoDeBomba(posicao)) {
              desenhoCampo += SETTINGS.bombas.simbolo;
            }
            else if (ehPosicaoDica(posicao)) {
              let dica = campo[x][y];

              desenhoCampo += SETTINGS.campo.simbolos[dica];
            } else {
              desenhoCampo += SETTINGS.campo.simbolos.aberto;
            }
          } else if (ehPosicaoDeBandeira(posicao)) {
            desenhoCampo += SETTINGS.bandeiras.simbolo;
          } else {
            desenhoCampo += SETTINGS.campo.simbolos.fechado;
          }

          desenhoCampo += '|';
        }

        desenhoCampo += '\n\r';
      }

      console.log(desenhoCampo);
      document.querySelector('#campo').innerHTML = desenhoCampo;
      document.querySelector('#emulador-log').innerHTML = '';
    }

    function sortearPosicaoNoCampo() {
      return [
        Math.floor(Math.random() * SETTINGS.campo.tamanhoX),
        Math.floor(Math.random() * SETTINGS.campo.tamanhoY)
      ];
    }

    function ehPosicaoDeBomba(posicao) {
      return posicoesBombas.some((posicaoBomba) => {
        return saoArraysIguais(posicaoBomba, posicao);
      });
    }

    function ehPosicaoNoCampo(posicao) {
      let [x, y] = posicao;

      return ehLinhaNoCampo(x) && ehColunaNoCampo(y);
    }

    function ehPosicaoAberta(posicao) {
      return posicoesAbertas.some((posicaoAberta) => {
        return saoArraysIguais(posicaoAberta, posicao);
      });
    }

    function ehPosicaoDica(posicao) {
      let [x, y] = posicao;

      return (
        campo[x][y] !== 0
        && campo[x][y] !== SETTINGS.bombas.simbolo
        && campo[x][y] !== SETTINGS.bandeiras.simbolo
      );
    }

    function ehPosicaoDeBandeira(posicao) {
      return posicoesBandeiras.some((posicaoBandeira) => {
        return saoArraysIguais(posicaoBandeira, posicao);
      });
    }

    function saoArraysIguais(array1, array2) {
      return array1.toString() === array2.toString();
    }

    function ehLinhaNoCampo(x) {
      return x >= 0 && x < SETTINGS.campo.tamanhoX;
    }

    function ehColunaNoCampo(y) {
      return y >= 0 && y < SETTINGS.campo.tamanhoY;
    }

    document.addEventListener('DOMContentLoaded', function(e) {
      inicializar();

      document.querySelector('#abrir-emulador-console').addEventListener('click', () => {
        document.querySelector('#emulador-console').showModal();
      });

      document.querySelector('#fechar-emulador-console').addEventListener('click', () => {
        document.querySelector('#emulador-console').close();
      });

      document.querySelector('#abrir-posicao').addEventListener('click', () => {
        let usuarioX = document.querySelector('#posicao-x').value;
        let usuarioY = document.querySelector('#posicao-y').value;

        abrirPosicao(usuarioX, usuarioY);

        document.querySelector('#posicao-x').value = '';
        document.querySelector('#posicao-y').value = '';
      });

      document.querySelector('#marcar-bomba').addEventListener('click', () => {
        let usuarioX = document.querySelector('#posicao-x').value;
        let usuarioY = document.querySelector('#posicao-y').value;

        marcarComBandeira(usuarioX, usuarioY);

        document.querySelector('#posicao-x').value = '';
        document.querySelector('#posicao-y').value = '';
      });

      document.querySelector('#reiniciar').addEventListener('click', () => {
        reiniciar();

        document.querySelector('#posicao-x').value = '';
        document.querySelector('#posicao-y').value = '';
      });
    });
  </script>
</body>
</html>
